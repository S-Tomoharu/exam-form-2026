<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>大学受験番号登録フォーム</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;
        
        const ChevronDown = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
        );
        
        const AlertCircle = ({ size = 24 }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="8" x2="12" y2="12"></line>
                <line x1="12" y1="16" x2="12.01" y2="16"></line>
            </svg>
        );
        
        const CheckCircle = ({ size = 24, className = "" }) => (
            <svg className={className} width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                <polyline points="22 4 12 14.01 9 11.01"></polyline>
            </svg>
        );
        
        const Loader = () => (
            <svg className="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
        );

        const StudentExamForm = () => {
            const [universityData, setUniversityData] = useState({});
            
            const [studentName, setStudentName] = useState('');
            const [email, setEmail] = useState('');
            const [university, setUniversity] = useState('');
            const [faculty, setFaculty] = useState('');
            const [department, setDepartment] = useState('');
            const [examNumber, setExamNumber] = useState('');
            
            const [universityInput, setUniversityInput] = useState('');
            const [facultyInput, setFacultyInput] = useState('');
            const [departmentInput, setDepartmentInput] = useState('');
            
            const [showUniversityDropdown, setShowUniversityDropdown] = useState(false);
            const [showFacultyDropdown, setShowFacultyDropdown] = useState(false);
            const [showDepartmentDropdown, setShowDepartmentDropdown] = useState(false);
            
            const [errors, setErrors] = useState({});
            const [showSubmitDialog, setShowSubmitDialog] = useState(false);
            const [isFinished, setIsFinished] = useState(false);
            const [isSubmitting, setIsSubmitting] = useState(false);

            useEffect(() => {
                const savedUniversities = localStorage.getItem('universityData');
                
                if (savedUniversities) {
                    setUniversityData(JSON.parse(savedUniversities));
                } else {
                    const defaultData = {
                        '東京大学_文学部_哲学科': { university: '東京大学', faculty: '文学部', department: '哲学科' },
                        '東京大学_文学部_史学科': { university: '東京大学', faculty: '文学部', department: '史学科' },
                        '京都大学_文学部_人文学科': { university: '京都大学', faculty: '文学部', department: '人文学科' },
                        '早稲田大学_政治経済学部_政治学科': { university: '早稲田大学', faculty: '政治経済学部', department: '政治学科' },
                        '上智大学_文学部_': { university: '上智大学', faculty: '文学部', department: '' },
                    };
                    setUniversityData(defaultData);
                    localStorage.setItem('universityData', JSON.stringify(defaultData));
                }
            }, []);

            const filteredData = Object.values(universityData);
            
            const universities = [...new Set(filteredData.map(item => item.university))].filter(u =>
                u.toLowerCase().includes(universityInput.toLowerCase())
            );
            
            const faculties = [...new Set(
                filteredData.filter(item => item.university === university).map(item => item.faculty)
            )].filter(f => f.toLowerCase().includes(facultyInput.toLowerCase()));
            
            const departments = [...new Set(
                filteredData.filter(item => item.university === university && item.faculty === faculty).map(item => item.department)
            )].filter(d => d.toLowerCase().includes(departmentInput.toLowerCase()));

            const handleUniversitySelect = (u) => {
                setUniversity(u);
                setUniversityInput(u);
                setShowUniversityDropdown(false);
                setFaculty('');
                setFacultyInput('');
                setDepartment('');
                setDepartmentInput('');
                setErrors({...errors, university: ''});
            };

            const handleFacultySelect = (f) => {
                setFaculty(f);
                setFacultyInput(f);
                setShowFacultyDropdown(false);
                setDepartment('');
                setDepartmentInput('');
                setErrors({...errors, faculty: ''});
            };

            const handleDepartmentSelect = (d) => {
                setDepartment(d);
                setDepartmentInput(d);
                setShowDepartmentDropdown(false);
                setErrors({...errors, department: ''});
            };

            const validateForm = () => {
                const newErrors = {};
                
                if (!studentName) newErrors.studentName = '生徒名を入力してください';
                if (!email) newErrors.email = 'メールアドレスを入力してください';
                else if (!email.includes('@')) newErrors.email = '正しいメールアドレスを入力してください';
                if (!university) newErrors.university = '大学名を選択してください';
                if (!faculty) newErrors.faculty = '学部を選択してください';
                if (departments.length > 0 && departments.filter(d => d).length > 0 && !department) {
                    newErrors.department = '学科を選択してください';
                }
                if (!examNumber) newErrors.examNumber = '受験番号を入力してください';
                
                setErrors(newErrors);
                return Object.keys(newErrors).length === 0;
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                
                if (!validateForm()) return;

                setIsSubmitting(true);

                const submissionData = {
                    studentName,
                    email,
                    university,
                    faculty,
                    department: department || '（学科なし）',
                    examNumber,
                };

                try {
                    await fetch('https://script.google.com/macros/s/AKfycbwjQ9mOmC-ySk2DjzCveFbPkCfDbJAMOS2pW5Gnl9YX9Fg7wzkWiaxR_5ht11uRb-cnZg/exec', {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(submissionData)
                    });

                    setIsSubmitting(false);
                    setShowSubmitDialog(true);
                } catch (error) {
                    setIsSubmitting(false);
                    alert('送信エラーが発生しました。もう一度お試しください。');
                }
            };

            const handleContinueInput = () => {
                setUniversity('');
                setFaculty('');
                setDepartment('');
                setExamNumber('');
                setUniversityInput('');
                setFacultyInput('');
                setDepartmentInput('');
                setErrors({});
                setShowSubmitDialog(false);
            };

            const handleFinishInput = () => {
                setShowSubmitDialog(false);
                setIsFinished(true);
            };

            if (isFinished) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-50 flex items-center justify-center p-4">
                        <div className="bg-white rounded-lg shadow-lg p-8 max-w-md w-full text-center">
                            <CheckCircle size={64} className="text-green-500 mx-auto mb-4" />
                            <h2 className="text-2xl font-bold text-gray-800 mb-4">送信完了</h2>
                            <p className="text-gray-700 mb-6">
                                データを受け取りました。<br />
                                受験結果はメールで教えてください。
                            </p>
                            <p className="text-sm text-gray-500">
                                このページを閉じて構いません。
                            </p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-50 p-4">
                    <div className="max-w-2xl mx-auto">
                        {showSubmitDialog && (
                            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                                <div className="bg-white rounded-lg p-6 max-w-lg w-full max-h-[90vh] overflow-y-auto">
                                    <div className="flex items-center gap-3 mb-4">
                                        <CheckCircle size={32} className="text-green-500" />
                                        <h3 className="text-xl font-bold text-gray-800">送信完了</h3>
                                    </div>
                                    
                                    <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                                        <h4 className="font-semibold text-gray-800 mb-3">入力内容の確認</h4>
                                        <div className="space-y-2 text-sm">
                                            <div className="flex"><span className="text-gray-600 w-24">生徒名:</span><span className="font-medium">{studentName}</span></div>
                                            <div className="flex"><span className="text-gray-600 w-24">メール:</span><span className="text-xs">{email}</span></div>
                                            <div className="flex"><span className="text-gray-600 w-24">大学:</span><span className="font-medium">{university}</span></div>
                                            <div className="flex"><span className="text-gray-600 w-24">学部:</span><span>{faculty}</span></div>
                                            <div className="flex"><span className="text-gray-600 w-24">学科:</span><span>{department || '（学科なし）'}</span></div>
                                            <div className="flex"><span className="text-gray-600 w-24">受験番号:</span><span className="font-bold text-blue-600">{examNumber}</span></div>
                                        </div>
                                    </div>

                                    <p className="text-sm text-gray-600 mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded">
                                        ※修正が必要な場合は改めてデータを送信してください。新しいデータを優先します。
                                    </p>

                                    <p className="text-gray-700 mb-4 font-medium">続けて別の大学を入力しますか？</p>
                                    
                                    <div className="flex flex-col sm:flex-row gap-3">
                                        <button onClick={handleContinueInput} className="flex-1 bg-blue-600 text-white py-3 px-4 rounded-lg font-medium hover:bg-blue-700">続けて入力する</button>
                                        <button onClick={handleFinishInput} className="flex-1 bg-gray-200 text-gray-700 py-3 px-4 rounded-lg font-medium hover:bg-gray-300">入力を終了する</button>
                                    </div>
                                    <p className="text-sm text-gray-500 mt-3 text-center">※「続けて入力」を選ぶと、生徒名とメールアドレスは保持されます</p>
                                </div>
                            </div>
                        )}

                        <div className="bg-white rounded-lg shadow-lg p-6 md:p-8">
                            <h1 className="text-2xl font-bold text-gray-800 mb-6">大学受験番号登録フォーム</h1>
                            
                            <div className="space-y-6">
                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">氏名 <span className="text-red-500">*</span></label>
                                    <input type="text" value={studentName} onChange={(e) => { setStudentName(e.target.value); setErrors({...errors, studentName: ''}); }} placeholder="山田太郎" className={`w-full px-4 py-3 border rounded-lg text-base ${errors.studentName ? 'border-red-500' : 'border-gray-300'}`} />
                                    {errors.studentName && <p className="mt-1 text-sm text-red-600 flex items-center gap-1"><AlertCircle size={14} />{errors.studentName}</p>}
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">メールアドレス <span className="text-red-500">*</span></label>
                                    <input type="email" value={email} onChange={(e) => { setEmail(e.target.value); setErrors({...errors, email: ''}); }} placeholder="example@email.com" className={`w-full px-4 py-3 border rounded-lg text-base ${errors.email ? 'border-red-500' : 'border-gray-300'}`} />
                                    {errors.email && <p className="mt-1 text-sm text-red-600 flex items-center gap-1"><AlertCircle size={14} />{errors.email}</p>}
                                </div>

                                <div className="relative">
                                    <label className="block text-sm font-medium text-gray-700 mb-2">大学名 <span className="text-red-500">*</span></label>
                                    <div className="relative">
                                        <input type="text" value={universityInput} onChange={(e) => { setUniversityInput(e.target.value); setShowUniversityDropdown(true); }} onFocus={() => setShowUniversityDropdown(true)} placeholder="大学名を入力または選択" className={`w-full px-4 py-3 border rounded-lg text-base ${errors.university ? 'border-red-500' : 'border-gray-300'}`} />
                                        <button type="button" onClick={() => setShowUniversityDropdown(!showUniversityDropdown)} className="absolute right-2 top-2.5 text-gray-400 p-1"><ChevronDown size={24} /></button>
                                    </div>
                                    {errors.university && <p className="mt-1 text-sm text-red-600 flex items-center gap-1"><AlertCircle size={14} />{errors.university}</p>}
                                    {showUniversityDropdown && universities.length > 0 && (
                                        <div className="absolute z-10 w-full mt-1 bg-white border rounded-lg shadow-lg max-h-60 overflow-y-auto">
                                            {universities.map((u, idx) => <div key={idx} onClick={() => handleUniversitySelect(u)} className="px-4 py-3 hover:bg-blue-50 cursor-pointer">{u}</div>)}
                                        </div>
                                    )}
                                </div>

                                <div className="relative">
                                    <label className="block text-sm font-medium text-gray-700 mb-2">学部 <span className="text-red-500">*</span></label>
                                    <div className="relative">
                                        <input type="text" value={facultyInput} onChange={(e) => { setFacultyInput(e.target.value); setShowFacultyDropdown(true); }} onFocus={() => setShowFacultyDropdown(true)} disabled={!university} placeholder={university ? "学部を入力または選択" : "先に大学を選択してください"} className={`w-full px-4 py-3 border rounded-lg disabled:bg-gray-100 text-base ${errors.faculty ? 'border-red-500' : 'border-gray-300'}`} />
                                        <button type="button" onClick={() => setShowFacultyDropdown(!showFacultyDropdown)} disabled={!university} className="absolute right-2 top-2.5 text-gray-400 p-1"><ChevronDown size={24} /></button>
                                    </div>
                                    {errors.faculty && <p className="mt-1 text-sm text-red-600 flex items-center gap-1"><AlertCircle size={14} />{errors.faculty}</p>}
                                    {showFacultyDropdown && faculties.length > 0 && (
                                        <div className="absolute z-10 w-full mt-1 bg-white border rounded-lg shadow-lg max-h-60 overflow-y-auto">
                                            {faculties.map((f, idx) => <div key={idx} onClick={() => handleFacultySelect(f)} className="px-4 py-3 hover:bg-blue-50 cursor-pointer">{f}</div>)}
                                        </div>
                                    )}
                                </div>

                                <div className="relative">
                                    <label className="block text-sm font-medium text-gray-700 mb-2">学科 {departments.length > 0 && departments.filter(d => d).length > 0 && <span className="text-red-500">*</span>}</label>
                                    <div className="relative">
                                        <input type="text" value={departmentInput} onChange={(e) => { setDepartmentInput(e.target.value); setShowDepartmentDropdown(true); }} onFocus={() => setShowDepartmentDropdown(true)} disabled={!faculty} placeholder={faculty ? (departments.filter(d => d).length > 0 ? "学科を入力または選択" : "（学科の指定なし）") : "先に学部を選択してください"} className={`w-full px-4 py-3 border rounded-lg disabled:bg-gray-100 text-base ${errors.department ? 'border-red-500' : 'border-gray-300'}`} />
                                        <button type="button" onClick={() => setShowDepartmentDropdown(!showDepartmentDropdown)} disabled={!faculty || departments.filter(d => d).length === 0} className="absolute right-2 top-2.5 text-gray-400 p-1"><ChevronDown size={24} /></button>
                                    </div>
                                    {errors.department && <p className="mt-1 text-sm text-red-600 flex items-center gap-1"><AlertCircle size={14} />{errors.department}</p>}
                                    {showDepartmentDropdown && departments.filter(d => d).length > 0 && (
                                        <div className="absolute z-10 w-full mt-1 bg-white border rounded-lg shadow-lg max-h-60 overflow-y-auto">
                                            {departments.filter(d => d).map((d, idx) => <div key={idx} onClick={() => handleDepartmentSelect(d)} className="px-4 py-3 hover:bg-blue-50 cursor-pointer">{d}</div>)}
                                        </div>
                                    )}
                                </div>

                                <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-2">受験番号 <span className="text-red-500">*</span></label>
                                    <input type="text" value={examNumber} onChange={(e) => { setExamNumber(e.target.value); setErrors({...errors, examNumber: ''}); }} placeholder="受験番号を入力" className={`w-full px-4 py-3 border rounded-lg text-base ${errors.examNumber ? 'border-red-500' : 'border-gray-300'}`} />
                                    {errors.examNumber && <p className="mt-1 text-sm text-red-600 flex items-center gap-1"><AlertCircle size={14} />{errors.examNumber}</p>}
                                </div>

                                <button 
                                    onClick={handleSubmit} 
                                    disabled={isSubmitting}
                                    className={`w-full py-4 rounded-lg font-medium text-lg shadow-md flex items-center justify-center gap-2 ${isSubmitting ? 'bg-gray-400 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700 text-white'}`}
                                >
                                    {isSubmitting ? (
                                        <>
                                            <Loader />
                                            送信中...
                                        </>
                                    ) : (
                                        '送信'
                                    )}
                                </button>
                            </div>
                        </div>

                        <div className="mt-4 text-center text-sm text-gray-600 bg-white rounded-lg p-4 shadow">
                            <p>※修正が必要な場合は改めてデータを送信してください。新しいデータを優先します。</p>
                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.render(<StudentExamForm />, document.getElementById('root'));
    </script>
</body>
</html>
